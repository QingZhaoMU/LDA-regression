rm(list=ls())
library(boot)

path <- 'c:/'

nsim <- 100

for (k in 1:nsim) {
#==============
# basic values
#==============
nc <- 3 # number of communities
nx <- 3 # number of covariates plus one
        # the first column for x is always 1, for intercept

nl <- 200 # number of sites
ns <- 200 # number of species

prop.perf <- .8 # proportion of sites with binomial data and perfect detection
                # rest of the sites have presence-only data (binary with imperfect detection)
nl.perf <- round(nl * prop.perf) # number of sites with perfect detection
nm1 <- 1 # number of surveys per site for areas with perfect detection
nm2 <- 1 # number of surveys per site for areas with imperfect detection
lpmu <- .5 # mean of logit detection probability
lpsigma <- .5 # standard deviation of logit detection probability
sigma <- 1 # standard deviation of the errors in logistic regression

#=================
# data simulation
#=================
# beta's, the first row is the intercept. Intercept is between -1 and 1, and the absolute values of slopes 
# are between 1 and 2, while slopes can be positive or negative
beta <- rbind(
  runif(nc,-1,1), 
  matrix(runif((nx-1)*nc,1,2)*sample(c(-1,1),(nx-1)*nc,replace=T), nrow=nx-1, ncol=nc)
        )

# covariates, the first column is 1 for the intercept
x <- cbind(1, matrix(rnorm(nl*(nx-1), 0, 1), nrow=nl, ncol=nx-1))

# theta, proportion of communities for each site
mu <- x %*% beta
vmat <- matrix(exp(rnorm(nl*nc, mu, sigma)), nrow=nl, ncol=nc)
vmat[,nc] <- 1
theta <- vmat / rowSums(vmat)
#colMeans(theta)
#table(rowSums(theta))

# phi, proportion of species for each community
phi <- matrix(rbeta(nc*ns, .2, .8), nrow=nc, ncol=ns)

# pi, probability of detecting a species in a site
pobs <- inv.logit(rnorm(ns, lpmu, lpsigma)) # species specific detection probability
id.perf <- sort(sample(1:nl, nl.perf, replace=F)) # sites with binomial data and perfect detection
pobs.mat <- matrix(pobs, nl, ns, byrow=T) # detection probability for each species and site
pobs.mat[id.perf,] <- 1 # sites with binomial data are assumed to have perfect detection
pi <- theta %*% phi * pobs.mat

nmat <- matrix(nm2, nl, ns)
nmat[id.perf,] <- nm1

# number of detections during nmat surveys
y <- matrix(rbinom(nl*ns, nmat, pi), nrow=nl, ncol=ns)

# save data
data <- list()
data$x <- x
data$y <- y
data$nc <- nc
data$nm1 <- nm1
data$nm2 <- nm2
data$sigma <- sigma
data$vmat <- vmat
data$phi <- phi
data$beta <- beta
data$prop.perf <- prop.perf
data$id.perf <- id.perf
data$lpmu <- lpmu
data$lpsigma <- lpsigma
data$pobs <- pobs

save(data, file=paste(c(path, 'data/sim data_', prop.perf, '_', nm1, '_', k, '.RData'), collapse=''))

} # k


